# Phase 3.5: Tests & Integration

**Date:** 2026-02-05
**Assemblies:** TurboHTTP.Tests.Runtime (tests), TurboHTTP.Transport (internals), TurboHTTP.Core

## What Was Implemented

- Added Core unit tests covering `UHttpClient`, `UHttpRequestBuilder`, `UHttpClientOptions`, and `HttpTransportFactory` behavior.
- Added HTTP/1.1 serializer and response parser unit tests with coverage for header handling, body parsing, limits, and error cases.
- Added TCP connection pool and RawSocketTransport behavioral tests (pool reuse, semaphore limits, retry-on-stale behavior, and non-keepalive semantics).
- Added a manual Unity Editor integration harness (`TestHttpClient`) that exercises httpbin.org endpoints and logs platform API availability.
- Updated CLAUDE.md to mark Phase 3 complete and document new test suites.

## Files Created

### `Tests/Runtime/Core/UHttpClientTests.cs`
- Core API tests, transport factory behavior, and error wrapping invariants.

### `Tests/Runtime/Transport/Http11SerializerTests.cs`
- HTTP/1.1 request serializer tests (Host, Connection, User-Agent, Content-Length, multi-value headers, IPv6 formatting).

### `Tests/Runtime/Transport/Http11ResponseParserTests.cs`
- HTTP/1.1 response parser tests (status line parsing, chunked decoding, limits, keep-alive semantics).

### `Tests/Runtime/Transport/TcpConnectionPoolTests.cs`
- Pool reuse, semaphore limit behavior, disposal semantics, and eviction safety.

### `Tests/Runtime/Transport/Http1/RawSocketTransportTests.cs`
- Transport behavior tests including retry-on-stale and non-keepalive permit release.

### `Tests/Runtime/TestHttpClient.cs`
- Manual integration harness for httpbin.org and platform API checks.

## Files Modified

- `CLAUDE.md` — Phase 3 status updated; test suites and integration harness documented.

## Decisions Made

1. **Large-memory tests gated:** `Parse_ReadToEnd_ExceedsMaxBodySize_ThrowsIOException` is marked `[Explicit]` to avoid allocating >100MB in routine runs.
2. **TLS tests gated:** TLS handshake verification tests are marked `[Explicit]`/`Inconclusive` pending a local TLS test server and certs.
3. **Deterministic stale retry:** RawSocketTransport retry-on-stale is validated with an injected failing stream (deterministic IOException) rather than flaky TCP reset timing.
4. **Reflection usage:** Tests access internal pool dictionaries and idle connections via reflection to validate eviction and TLS negotiation state without exposing new public API.

## Review Results

- **Infrastructure review:** PASS — tests-only changes; no new production code paths introduced.
- **Network review:** PASS — tests align with protocol expectations; flaky paths marked Explicit.

---

## Full Phase 3 Review (2026-02-05)

Both specialist agents reviewed the complete Phase 3 implementation (sub-phases 3.1–3.4).

### Infrastructure Architect Review

**Overall:** PASSING with 1 critical fix applied

**Critical Issue Fixed:**
- **ConnectionLease.ReturnToPool() race condition** — Added try-catch around `IsAlive` check to handle `ObjectDisposedException` from racing `Dispose()` call on another thread.

**High-Priority Deferred (Phase 10):**
1. Byte-by-byte `ReadLineAsync` (~29KB Task allocations per response)
2. StringBuilder serialization (~600-700 bytes per request)
3. `MemoryStream.ToArray()` body copy

**Medium-Priority Applied:**
- `RawSocketTransport.Dispose()` idempotency guard added

**Verified Correct:**
- Module dependency rules (Core → Transport, no bidirectional)
- Transport factory pattern with `Lazy<T>` thread safety
- Error model with `UHttpException` first-catch handler
- `ConnectionLease` semaphore release invariant
- `PooledConnection.LastUsed` atomicity via `Interlocked`
- IL2CPP safeguards (reflection probes, link.xml, encoding fallback)

### Network Architect Review

**Overall:** APPROVED for Phase 3.5 testing

**Protocol Correctness (RFC 9110/9112):** PASS
- Request line format, Host header, IPv6 brackets
- Content-Length validation, Transfer-Encoding precedence
- Chunked encoding with extensions, 1xx interim responses
- Keep-alive detection, Latin-1 encoding

**Platform Compatibility:** PASS
- WebGL correctly excluded in asmdef
- IL2CPP safeguards verified
- IPv6 support for App Store requirements

**TLS/Security:** PASS
- `SslProtocols.None` with TLS 1.2 minimum enforcement
- Certificate validation callback (static method, IL2CPP safe)
- ALPN via reflection with silent fallback

**Connection Pooling:** PASS
- Per-host semaphores, stale retry for idempotent methods
- Disposal chain (`SslStream → NetworkStream → Socket`)

### Files Modified in This Review

| File | Change |
|------|--------|
| `Runtime/Transport/Tcp/TcpConnectionPool.cs` | Added try-catch for `ObjectDisposedException` in `ReturnToPool()` |
| `Runtime/Transport/RawSocketTransport.cs` | Added idempotency guard to `Dispose()` |

### Phase 3.5 Validation Requirements

1. **IL2CPP Build Test (MANDATORY):** Physical iOS device, verify ALPN reflection, encoding, module initializer
2. **HTTP/1.1 Conformance:** Chunked with extensions, multiple Content-Length, 1xx, HEAD
3. **Connection Pool:** Stale retry (idempotent only), per-host limits, idle timeout
4. **Timeout/Cancellation:** DNS timeout (5s), request timeout, user cancellation
5. **Memory Profiling:** Verify ~50KB GC budget, identify Phase 10 hotspots
