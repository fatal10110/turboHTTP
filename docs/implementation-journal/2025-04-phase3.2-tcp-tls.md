# Phase 3.2: TCP Connection Pool & TLS

**Status:** COMPLETE

## What was implemented

Connection pooling with per-host concurrency control, TLS handshake with ALPN support, IL2CPP stripping protection.

## Files created

- `Runtime/Transport/Tcp/TcpConnectionPool.cs` — PooledConnection class (Socket, Stream, host/port, IsSecure, IsReused, atomic LastUsed via Interlocked, NegotiatedTlsVersion, IsAlive liveness check). ConnectionLease class (IDisposable, wraps connection + semaphore, thread-safe ReturnToPool/Dispose with lock, IsAlive check outside lock to avoid syscall under lock). TcpConnectionPool class (ConcurrentDictionary/ConcurrentQueue, per-host SemaphoreSlim concurrency limit default 6, idle timeout 2 min, max 1000 semaphore entries with eviction). DNS resolution with 5s timeout wrapper. IPv6-safe socket connection with NoDelay. Dispose-on-cancel pattern.
- `Runtime/Transport/Tls/TlsStreamWrapper.cs` — Static TLS utility with runtime probe for .NET 5+ SslClientAuthenticationOptions overload. Primary path: reflection-invoked overload with CancellationToken + ALPN. Fallback: 4-arg overload with Task.WhenAny cancellation (no ALPN). SslProtocols.None (OS negotiation) with post-handshake TLS 1.2 minimum enforcement. ALPN via reflection PropertyInfo.SetValue. Static certificate validation callback. Returns TlsResult struct.
- `Runtime/Transport/link.xml` — IL2CPP stripping protection for SslStream, SslClientAuthenticationOptions, SslApplicationProtocol, System.Text.Encoding.CodePages.

## Decisions

- ConnectionLease as class (not struct) for reliable IDisposable semantics. Idempotent Dispose prevents double semaphore release.
- SslProtocols.None per Microsoft recommendation. TLS 1.2 minimum enforced post-handshake (not pre-negotiation).
- Reflection probe for .NET 5+ SslClientAuthenticationOptions API compatibility on .NET Standard 2.1.
- 4-arg fallback path uses Task.WhenAny for cancellation (no native CancellationToken support). No ALPN on fallback path.
- DNS timeout is 5s best-effort wrapper (Dns.GetHostAddressesAsync has no CancellationToken in .NET Standard 2.1).
- Socket.ConnectAsync cancellation via ct.Register(() => socket.Dispose()) pattern.
- Per-host concurrency default 6 (matches browser convention). Max 1000 semaphore entries with LRU eviction.
