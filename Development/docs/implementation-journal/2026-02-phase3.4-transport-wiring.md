# Phase 3.4: RawSocketTransport & Wiring

**Date:** 2026-02-03
**Assembly:** TurboHTTP.Transport

## What Was Implemented

The default `IHttpTransport` implementation that wires together the connection pool (Phase 3.2), HTTP/1.1 serializer/parser (Phase 3.3), and client API (Phase 3.1) into a complete request/response cycle. Also implemented the module initializer auto-registration pattern with a .NET Standard 2.1 polyfill.

## Files Created

### `Runtime/Transport/Internal/ModuleInitializerAttribute.cs`
- Polyfill for `[ModuleInitializer]` attribute on .NET Standard 2.1
- Guarded with `#if !NET5_0_OR_GREATER` to avoid conflicts on newer runtimes
- `internal` visibility prevents cross-assembly conflicts

### `Runtime/Transport/RawSocketTransport.cs`
- `IHttpTransport` implementation using raw TCP sockets
- Timeout enforcement via linked `CancellationTokenSource`
- URI validation (absolute URI, http/https schemes only)
- Retry-on-stale for idempotent methods (GET, HEAD, PUT, DELETE, OPTIONS)
- Exception mapping with load-bearing catch order (UHttpException first to prevent double-wrap)
- Timeline events: TransportStart, TransportConnecting, TransportSending, TransportReceiving, TransportComplete, TransportRetryStale
- `SendOnLeaseAsync` helper to avoid variable scoping issues in retry path
- `BuildResponse` helper for DRY response construction
- `EnsureRegistered()` static method for test/IL2CPP fallback
- `ObjectDisposedException` guard with `volatile bool _disposed`

### `Runtime/Transport/TransportModuleInitializer.cs`
- `[ModuleInitializer]` auto-registers `RawSocketTransport` with `HttpTransportFactory`
- Fires when the TurboHTTP.Transport assembly is first loaded
- IL2CPP timing documented with `EnsureRegistered()` fallback

## Decisions Made

1. **Scheme comparison:** Used `StringComparison.OrdinalIgnoreCase` instead of `ToLowerInvariant()` to avoid per-request string allocation. `Uri.Scheme` is already normalized by .NET but defensive comparison is zero-cost.
2. **Retry timeline events:** Added `TransportConnecting` after `TransportRetryStale` in the retry path to maintain consistent event sequences for diagnostics.
3. **Disposed guard:** Added `volatile bool _disposed` with `ObjectDisposedException` at the top of `SendAsync` for clear diagnostics when transport is used after disposal.
4. **SocketException catch ordering:** Kept `SocketException` after `IOException` because they are on separate inheritance branches (`SocketException` → `Win32Exception`, not `IOException`). Both are reachable on Unity's Mono runtime.
5. **Semaphore re-acquisition on retry:** Documented as acceptable for Phase 3. Permit-preserving retry deferred to Phase 10 optimization.

## Review Results

- **Infrastructure review (pass 1):** Approved — 0 must-fix, 1 optional doc enhancement
- **Network review (pass 1):** Approved — 0 must-fix, 3 should-fix (scheme allocation, retry timeline, disposed guard)
- **Both verification reviews (pass 2):** All fixes confirmed correct, no regressions
